pipeline {
    agent {
        kubernetes {
            cloud 'dev-kube'
            yamlFile 'pipeline/jenkins/agent/pod.yaml'
            serviceAccount 'jenkins-admin'
        }
    }
    stages {
        stage('Build Config Test') {
            when { changeset "spring-petclinic-config-server/**" }
            steps {
                container('docker') {
                    sh '''
                    sh scripts/devops/build_image.sh $CONFIG_DOCKER_IMAGE local
                    '''
                }
            }
        }
        stage('Build Discovery Test') {
            when { changeset "spring-petclinic-discovery-server/**" }
            steps {
                container('docker') {
                    sh '''
                    sh scripts/devops/build_image.sh $DISCOVERY_DOCKER_IMAGE local
                    '''
                }
            }
        }
        stage('Build Cusmomers Test') {
            when { changeset "spring-petclinic-customers-service/**" }
            steps {
                container('docker') {
                    sh '''
                    sh scripts/devops/build_image.sh $CUSTOMERS_DOCKER_IMAGE local
                    '''
                }
            }
        }
        stage('Build Vets Test') {
            when { changeset "spring-petclinic-vets-service/**" }
            steps {
                container('docker') {
                    sh '''
                    sh scripts/devops/build_image.sh $VETS_DOCKER_IMAGE local
                    '''
                }
            }
        }
        stage('Build Visits Test') {
            when { changeset "spring-petclinic-visits-service/**" }
            steps {
                container('docker') {
                    sh '''
                    sh scripts/devops/build_image.sh $VISITS_DOCKER_IMAGE local
                    '''
                }
            }
        }
        stage('Build Admin Test') {
            when { changeset "spring-petclinic-admin-server/**" }
            steps {
                container('docker') {
                    sh '''
                    sh scripts/devops/build_image.sh $ADMIN_DOCKER_IMAGE local
                    '''
                }
            }
        }
        stage('Build Api-gateway Test') {
            when { changeset "spring-petclinic-api-gateway/**" }
            steps {
                container('docker') {
                    sh '''
                    sh scripts/devops/build_image.sh $APIGATEWAY_DOCKER_IMAGE local
                    '''
                }
            }
        }
    }
}
/*
podTemplate(cloud: 'dev-kube', serviceAccount: 'jenkins-admin', 
            yaml: readTrusted('pipeline/jenkins/agent/pod.yaml'),
            envVars: [
                envVar(key: 'PETCLINIC_HOME', value: '/home/jenkins/agent/workspace/petclinic'),
                envVar(key: 'DOCKER_ID', value: 'agdgpn'),
                envVar(key: 'CONFIG_DOCKER_IMAGE', value: 'config'),
                envVar(key: 'DISCOVERY_DOCKER_IMAGE', value: 'discovery'),
                envVar(key: 'CUSTOMERS_DOCKER_IMAGE', value: 'customers'),
                envVar(key: 'VETS_DOCKER_IMAGE', value: 'vets'),
                envVar(key: 'VISITS_DOCKER_IMAGE', value: 'visits'),
                envVar(key: 'ADMIN_DOCKER_IMAGE', value: 'admin'),
                envVar(key: 'APIGATEWAY_DOCKER_IMAGE', value: 'api-gateway'),
                envVar(key: 'DOCKER_TAG', value: 'v.${BUILD_ID}.0')
            ]) {
    node {
    checkout scm 
    }
    node(POD_LABEL) {

        stage('Docker Build Test images') {
            container('docker') {
                sh '''
                ls
                pwd
                sh scripts/devops/build_image.sh $CONFIG_DOCKER_IMAGE local
                sh scripts/devops/build_image.sh $DISCOVERY_DOCKER_IMAGE local
                sh scripts/devops/build_image.sh $CUSTOMERS_DOCKER_IMAGE local
                sh scripts/devops/build_image.sh $VETS_DOCKER_IMAGE local
                sh scripts/devops/build_image.sh $VISITS_DOCKER_IMAGE local
                sh scripts/devops/build_image.sh $ADMIN_DOCKER_IMAGE local
                sh scripts/devops/build_image.sh $APIGATEWAY_DOCKER_IMAGE local
                '''   
            }
        }
    }
}
*/